# 提示词模板增强工作清单与实现文档

## 1. 目标与范围

本次改造目标：

1. 在设置页「提示词模板」区域增加 **JSON 导入/导出**。
2. 统一提示词模板 JSON 文件格式，支持跨用户共享与批量导入。
3. 在 RH 工作台的提示词输入「预设」按钮，支持 **最多同时选择 5 个模板**并组合填入。
4. 组合时考虑 RunningHub 侧上限，按 **4000 字符**做校验。
5. 修复提示词输入相关的“本地截断感”问题（设置页模板内容、工作区提示词输入）。
6. 修复升级后旧用户 `timeout=90s` 覆盖新默认 `180s` 的问题（引入设置迁移策略）。

不在本次范围：

1. 不改 RunningHub 接口协议。
2. 不改 AI 应用解析逻辑主流程（仅对提示词模板与设置迁移做增强）。
3. 不改插件整体视觉风格。

---

## 2. 交付物清单

1. 代码改造（`settings-controller` / `workspace-controller` / `workspace-inputs` / `store` / `index.html` / `style.css`）。
2. 统一 JSON 文件格式规范。
3. 设置迁移策略（schema version）。
4. 功能验收清单（手动测试项）。
5. 本文档（用于跟踪与复盘）。

---

## 3. 工作清单（可勾选）

## 阶段 A：数据层与迁移
- [x] A1. 为设置增加 `schemaVersion`（如 `2`），保存时写入版本号。
- [x] A2. 在 `getSettings()` 中加入迁移：旧版本配置若 `timeout < 180`，自动提升到 `180` 并回写。
- [x] A3. 提示词模板数据规范化：`id` 唯一、`title/content` 合法、时间字段兜底。
- [x] A4. 提供模板 JSON 构建/解析能力（导出 bundle、导入解析）。

## 阶段 B：设置页 JSON 导入/导出
- [x] B1. 设置页新增按钮：`导出 JSON`、`导入 JSON`。
- [x] B2. 导出逻辑：导出当前全部模板到 JSON 文件。
- [x] B3. 导入逻辑：读取 JSON -> 校验格式 -> 合并模板（同标题覆盖）-> 保存并刷新。
- [x] B4. 导入/导出异常提示与日志记录（取消、格式错误、读写失败）。

## 阶段 C：工作台模板组合（最多 5 个）
- [x] C1. 模板弹窗支持两种模式：单选模式 / 多选模式。
- [x] C2. 预设按钮进入多选模式，最多选择 5 项。
- [x] C3. 组合规则：按选中顺序拼接为一个提示词文本（建议换行拼接）。
- [x] C4. 组合长度校验：超过 4000 字符阻止应用并提示。

## 阶段 D：输入长度与稳定性修复
- [x] D1. 设置页模板内容保存不做不必要截断（保留用户原始内容）。
- [x] D2. 工作区提示词输入保留完整文本，不做本地长度截断。
- [x] D3. 提示文案统一：插件本地不截断，建议控制在 4000 字符内。

## 阶段 E：联调与验收
- [ ] E1. 导出 -> 导入回环验证（数据一致性）。
- [ ] E2. 导入他人 JSON 验证（兼容性）。
- [ ] E3. 多模板组合验证（1~5 个、超限阻断）。
- [ ] E4. 升级迁移验证（旧 `90s` 自动提升）。
- [ ] E5. 回归验证（现有模板编辑/删除、工作台运行流程不回归）。

---

## 4. 统一 JSON 格式规范（提案）

```json
{
  "format": "pixelrunner.prompt-templates",
  "version": 1,
  "exportedAt": "2026-02-20T12:34:56.000Z",
  "templates": [
    {
      "id": "id_1700000000000_xxx",
      "title": "高质量二次元",
      "content": "masterpiece, best quality, ...",
      "createdAt": 1700000000000
    }
  ]
}
```

规范说明：

1. `format`：固定值，用于识别文件类型。
2. `version`：格式版本，当前为 `1`。
3. `templates`：模板数组，`title/content` 必填。
4. 导入时允许：
   - 标准 bundle（如上结构）。
   - 纯数组（兼容场景），但会统一规范化后保存。

---

## 5. 关键实现设计

## 5.1 导入合并策略

默认策略：**按标题去重，导入覆盖同标题模板**。

1. 读取现有模板列表。
2. 以 `title.trim().toLowerCase()` 建立索引。
3. 导入模板命中同标题时覆盖内容（保留现有稳定 ID）。
4. 未命中则追加。
5. 保存时再次做模板规范化，保证 `id` 唯一。

原因：

1. 避免重复模板堆积。
2. 保留现有记录 ID，减少删除/编辑引用问题。

## 5.2 多模板组合规则

1. 选择上限：`maxSelect = 5`。
2. 组合顺序：按用户点击顺序。
3. 拼接方式：`"\n"`（换行）拼接。
4. 长度校验：组合后字符数 `<= 4000` 才允许应用。

## 5.3 超时迁移策略

1. 保存设置时写入 `schemaVersion`。
2. 读取设置时：
   - 若是旧版本配置（无 version 或 version 过低），且 `timeout < 180`；
   - 自动提升到 `180` 并回写。

---

## 6. 验收标准（DoD）

1. 设置页可成功导出当前全部模板为 JSON 文件。
2. 可导入自己或他人的导出文件，导入后模板可正常编辑/删除/使用。
3. 工作台预设支持最多 5 个模板组合，并能正确写入提示词输入框。
4. 超过 4000 字符时有明确提示，且不会提交超限组合。
5. 设置页与工作区提示词输入不出现插件本地截断。
6. 旧用户 `timeout=90s` 升级后自动迁移到 `180s`（且可再次手动调整）。
7. 原有功能无明显回归（解析、运行、下载回贴、模板 CRUD）。

---

## 7. 测试用例清单

1. 导出空模板列表（或仅默认模板）是否成功。
2. 导出后立即导入，条目数与内容一致。
3. 导入格式错误 JSON，提示是否清晰。
4. 导入包含重复标题模板，是否按策略覆盖。
5. 工作台选择 1/3/5 个模板组合是否正确。
6. 工作台尝试选择第 6 个模板是否被拦截。
7. 组合结果正好 4000 字符是否可用。
8. 组合结果 4001 字符是否阻止。
9. 旧配置 `timeout=90` 启动后是否迁移为 `180`。
10. 新用户未配置设置时默认 `timeout=180` 是否生效。

---

## 8. 进度记录

> 更新时间：2026-02-20

当前状态：

1. [x] 需求拆解与方案设计完成。
2. [x] A-D 阶段代码改造完成（待 E 阶段联调与验收）。
3. [x] 本轮用户验收通过（截断问题修复成功，长文本输入链路稳定）。

变更日志（执行中持续追加）：

1. `store.js`：增加 settings schemaVersion 迁移、timeout 旧值提升、模板 bundle 导入导出解析。
2. `settings-controller.js` + `index.html`：增加 JSON 导入导出按钮及逻辑，模板保存保留原始内容。
3. `workspace-controller.js` + `workspace-inputs.js`：模板弹窗支持多选组合（最多 5 个），并加入 4000 字符上限拦截。
4. `style.css`：补充模板弹窗操作区与布局样式。
5. `settings-controller.js` + `workspace-inputs.js`：对长文本输入框强制提高 `maxlength`（20000）并接管粘贴插入，规避宿主默认粘贴链路潜在截断。
6. `workspace-controller.js` + `runninghub-runner.js`：增加两段长度观测日志（运行前输入值 + 提交前最终值），用于精准判断截断发生点。
7. `runninghub-runner.js`：AI App 请求中 `text/prompt` 参数不再附带 `fieldData`，降低后端按字段元数据覆盖 `fieldValue` 的风险。
8. 验收结果：用户确认“修改成功，验收成功”，截断问题关闭。
9. 版本升级：所有显示版本号统一为 `V2.0.4`，`manifest.json` 同步升级到 `2.0.4`。
